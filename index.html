<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="apple-touch-icon" href="icon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>TXT 런처</title>
  <meta name="theme-color" content="#69b10d">
  <style>
    :root { --accent:#69b10d; --card:#fff; --bg:#f7fafc; --border:#e5e7eb; --text:#0f172a; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}

    /* Header */
    header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 14px; z-index:20; }
    .bar{ max-width:980px; margin:0 auto; display:flex; gap:12px; align-items:flex-start; }
    .logo{ flex-shrink:0; }
    .repo{ font-size:12px; color:#475569 }
    .header-info{ flex:1; display:flex; flex-direction:column; gap:6px; }
    .tools-top{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tools-bottom{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* Controls */
    .input{ height:36px; padding:0 12px; border:1px solid var(--border); background:#fff; border-radius:10px; flex:1; min-width:140px; }
    .btn{ height:36px; padding:0 12px; border:1px solid var(--border); background:#fff; border-radius:10px; font-weight:700; font-size:13px; cursor:pointer; }
    .btn.primary{ background:var(--accent); color:#fff; border-color:transparent; }
    .btn.toggle[aria-pressed="true"]{ background:#111; color:#fff; border-color:#111; }
    .btn.ghost{ background:transparent; }

    /* Layout */
    main{ padding:14px; max-width:980px; margin:0 auto; display:flex; flex-direction:column; gap:36px; }
    .list{ display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .name{ font-weight:900; font-size:14px; word-break:break-all; display:flex; align-items:center; gap:8px; }
    .name .chev{ font-size:16px; opacity:.7; transition: transform .18s ease; }
    .meta{ font-size:12px; color:#64748b; display:flex; gap:8px; flex-wrap:wrap; }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    .preview{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; line-height:1.5; color:#111827; background:#f1f5f9; border:1px dashed #cbd5e1; border-radius:10px; padding:10px; max-height:180px; overflow:auto; white-space:pre-wrap; }
    .empty, .error{ text-align:center; color:#475569; margin-top:32px; }
    footer{ padding:18px; text-align:center; color:#94a3b8; font-size:12px; }

    /* Separator */
    .section-sep{ border-top:2px solid var(--border); margin:20px 0; height:0; }

    /* —— 제목만 보기 모드 —— */
    body.titles-only .card .meta,
    body.titles-only .card .btns,
    body.titles-only .card .preview { display:none; }
    body.titles-only .card .name { cursor:pointer; }
    body.titles-only .card.expanded .meta,
    body.titles-only .card.expanded .btns,
    body.titles-only .card.expanded .preview { display:block; }
    body.titles-only .card.expanded .name .chev{ transform: rotate(90deg); }

    /* Repo cards */
    .repo-card .title{ font-weight:800; }
    .repo-card .desc{ font-size:12px; color:#475569; }
    .repo-card .link{ font-size:12px; }
  </style>
</head>
<body class="titles-only">
  <header>
    <div class="bar">
      <div class="logo"><img src="icon.png" alt="icon" style="height:5em; border-radius:12px;"></div>
      <div class="header-info">
        <div class="repo" id="repoLabel"></div>
        <div class="tools-top">
          <input id="q" class="input" type="search" placeholder="파일 검색…" />
        </div>
        <div class="tools-bottom">
          <button class="btn" id="refreshBtn" title="목록 새로고침">new</button>
          <button class="btn toggle" id="titlesOnlyBtn" aria-pressed="true" title="제목만 보기 토글">Title</button>
          <button class="btn ghost" id="expandAllBtn" style="display:inline-block;" title="모두 펼치기/접기">모두 펼치기</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div id="list" class="list" aria-live="polite"></div>
    <div class="section-sep"></div>
    <div id="repos" class="list" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none;">표시할 txt 파일이 없어요.</div>
    <div id="err" class="error" style="display:none;"></div>
  </main>

  <footer>자동 목록 갱신 · GitHub Contents API 사용</footer>

<script>
// ======= 설정 =======
const OWNER  = "hodewdew-creator";
const REPO   = "ZHYUNK";
const BRANCH = "main";
const DIR    = ""; // 루트
const GITHUB_TOKEN = ""; // private 레포면 토큰
const GITHUB_USER  = "hodewdew-creator"; // 하단 repo 목록용

// ======= 공통 DOM =======
const repoLabel = document.getElementById('repoLabel');
repoLabel.textContent = `${OWNER}/${REPO}@${BRANCH}${DIR ? " / "+DIR : ""}`;

const $list = document.getElementById('list');
const $repos = document.getElementById('repos');
const $empty = document.getElementById('empty');
const $err = document.getElementById('err');
const $q = document.getElementById('q');
const $refresh = document.getElementById('refreshBtn');
const $titlesToggle = document.getElementById('titlesOnlyBtn');
const $expandAll = document.getElementById('expandAllBtn');

let titlesOnly = true; // 초기 제목만 보기
let allFiles = [];
let expandStateAll = false;

// ======= TXT 목록 =======
const apiBase = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(DIR)}?ref=${encodeURIComponent(BRANCH)}`;

async function fetchTxtList(){
  $err.style.display = "none";
  $empty.style.display = "none";
  $list.innerHTML = "";
  try{
    const headers = { "Accept": "application/vnd.github+json" };
    if(GITHUB_TOKEN) headers["Authorization"] = `Bearer ${GITHUB_TOKEN}`;
    const res = await fetch(apiBase, { headers });
    if(!res.ok){
      const text = await res.text();
      throw new Error(`API ${res.status}: ${text}`);
    }
    const data = await res.json();
    const items = Array.isArray(data) ? data : [data];
    const txts = items.filter(x => x.type === "file" && x.name.toLowerCase().endsWith(".txt"));
    txts.sort((a,b)=> a.name.localeCompare(b.name, 'ko'));
    allFiles = txts;
    renderTxtCards(txts);
  }catch(e){
    console.error(e);
    $err.textContent = "불러오기에 실패했어요. (깃허브 API 제한이거나 설정값이 잘못됨)";
    $err.style.display = "block";
  }
}

function renderTxtCards(files){
  $list.innerHTML = "";
  if(files.length === 0){ $empty.style.display = "block"; return; }

  const frag = document.createDocumentFragment();
  files.forEach(f => {
    const card = document.createElement('div');
    card.className = "card";

    const name = document.createElement('div');
    name.className = "name";
    name.innerHTML = `<span class="chev">▸</span><span class="t">${escapeHtml(f.name)}</span>`;

    const meta = document.createElement('div');
    meta.className = "meta";
    meta.innerHTML = `
      <span>size: ${formatSize(f.size)}</span>
      <span>path: ${escapeHtml(f.path)}</span>
    `;

    const btns = document.createElement('div');
    btns.className = "btns";
    const rawUrl = f.download_url || rawUrlFromPath(f.path);

    const isAutoRepoList = /내가만든앱들총리스트\.txt$/i.test(f.name);
    const viewBtn = button(isAutoRepoList? "동기화 보기" : "보기", "primary", async () => {
      try{
        if(isAutoRepoList){
          const text = await buildRepoListText();
          pre.textContent = text;
        } else {
          const text = await fetchTextSmart(rawUrl, f.path);
          pre.textContent = firstLines(text, 2000);
        }
        if(titlesOnly && !card.classList.contains('expanded')){
          card.classList.add('expanded');
          updateChevrons();
        }
      }catch(err){
        pre.textContent = `불러오기 실패: ${err?.message || err}`;
      }
    });

    const rawBtn = linkBtn("원본 열기", rawUrl);
    const ghBtn  = linkBtn("GitHub 보기", f.html_url);
    btns.append(viewBtn, rawBtn, ghBtn);

    const pre = document.createElement('pre');
    pre.className = "preview";
    pre.textContent = "미리보기를 누르면 내용이 보여요.";

    name.addEventListener('click', ()=>{
      if(!titlesOnly) return;
      card.classList.toggle('expanded');
      updateChevrons();
    });

    card.append(name, meta, btns, pre);
    frag.appendChild(card);
  });
  $list.appendChild(frag);
  updateChevrons();
}

// ======= Repo 목록(하단) =======
async function fetchAndRenderRepos(){
  $repos.innerHTML = "";
  try{
    const url = `https://api.github.com/users/${GITHUB_USER}/repos?per_page=100&sort=updated`;
    const headers = { "Accept":"application/vnd.github+json" };
    if(GITHUB_TOKEN) headers["Authorization"] = `Bearer ${GITHUB_TOKEN}`;
    const res = await fetch(url, { headers });
    if(!res.ok){ throw new Error(`repo api ${res.status}`); }
    const repos = await res.json();
    if(!Array.isArray(repos)) throw new Error("unexpected repos response");

    const frag = document.createDocumentFragment();
    repos.forEach(r => {
      const c = document.createElement('div');
      c.className = 'card repo-card';
      c.innerHTML = `
        <div class="title">${escapeHtml(r.name)}</div>
        <div class="link"><a href="${r.html_url}" target="_blank" rel="noopener noreferrer">${r.html_url}</a></div>
        <div class="desc">${escapeHtml(r.description || "(설명 없음)")}</div>
      `;
      frag.appendChild(c);
    });
    $repos.appendChild(frag);
  }catch(err){
    console.error(err);
    $repos.innerHTML = '<div class="error">레포 목록을 불러오지 못했습니다.</div>';
  }
}

// ======= 유틸 =======
function button(label, cls, onClick){
  const b = document.createElement('button');
  b.className = `btn ${cls||""}`;
  b.type = 'button';
  b.textContent = label;
  b.onclick = onClick;
  return b;
}
function linkBtn(label, href){
  const a = document.createElement('a');
  a.className = "btn";
  a.textContent = label;
  a.href = href;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  return a;
}
async function fetchText(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error("raw fetch error");
  return await res.text();
}
async function fetchTextSmart(rawUrl, path){
  try{
    return await fetchText(rawUrl);
  }catch(_){
    const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(BRANCH)}`;
    const headers = { "Accept": "application/vnd.github+json" };
    if(GITHUB_TOKEN) headers["Authorization"] = `Bearer ${GITHUB_TOKEN}`;
    const r = await fetch(api, { headers });
    if(!r.ok) throw new Error("github api fetch error");
    const j = await r.json();
    if(!j.content) throw new Error("no content field");
    const decoded = atob(j.content.replace(/\n/g, ""));
    return decoded;
  }
}
function firstLines(str, maxChars){
  return (str.length > maxChars) ? str.slice(0,maxChars) + "\n…(이하 생략)" : str;
}
function formatSize(n){
  if(n < 1024) return n + " B";
  if(n < 1024*1024) return (n/1024).toFixed(1) + " KB";
  return (n/1024/1024).toFixed(1) + " MB";
}
function rawUrlFromPath(path){
  return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${encodeURIComponent(path).replace(/%2F/g,'/')}`;
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

// ======= 이벤트 =======
$q.addEventListener('input', ()=>{
  const q = $q.value.trim().toLowerCase();
  if(!q){ renderTxtCards(allFiles); return; }
  renderTxtCards(allFiles.filter(f => f.name.toLowerCase().includes(q) || f.path.toLowerCase().includes(q)));
});
$refresh.addEventListener('click', ()=>{ fetchTxtList(); fetchAndRenderRepos(); });
$titlesToggle.addEventListener('click', ()=>{
  titlesOnly = !titlesOnly;
  document.body.classList.toggle('titles-only', titlesOnly);
  $titlesToggle.setAttribute('aria-pressed', String(titlesOnly));
  $expandAll.style.display = titlesOnly ? 'inline-block' : 'none';
  expandStateAll = false;
  $expandAll.textContent = '모두 펼치기';
  updateChevrons();
});
$expandAll.addEventListener('click', ()=>{
  if(!titlesOnly) return;
  expandStateAll = !expandStateAll;
  document.querySelectorAll('.card').forEach(c => {
    c.classList.toggle('expanded', expandStateAll);
  });
  $expandAll.textContent = expandStateAll ? '모두 접기' : '모두 펼치기';
  updateChevrons();
});

function updateChevrons(){
  document.querySelectorAll('#list .card .chev').forEach((el)=>{
    el.style.visibility = titlesOnly ? 'visible' : 'hidden';
    const expanded = el.closest('.card')?.classList.contains('expanded');
    el.style.transform = expanded ? 'rotate(90deg)' : 'rotate(0deg)';
  });
}

// ======= 초기 로드 =======
fetchTxtList();
fetchAndRenderRepos();
</script>
</body>
</html>
