<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PillCounter ‚Äì Web Prototype v3.4</title>
  <style>
    body{margin:0;background:#f9fafb;color:#111827;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:14px;background:#2563eb;color:white;position:sticky;top:0;z-index:10;}
    header h1{margin:0;font-size:20px;font-weight:700;}
    .stage{position:relative;aspect-ratio:3/4;background:#e5e7eb;overflow:hidden}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .controls{display:flex;gap:8px;flex-wrap:wrap;padding:10px;background:#f3f4f6}
    .controls input{flex:1;padding:8px;border-radius:6px;border:1px solid #d1d5db;background:white;color:#111827}
    .controls button{flex:1;padding:10px;border:none;border-radius:6px;background:#2563eb;color:white;font-weight:600;cursor:pointer}
    .controls button.secondary{background:#6b7280}
    .badge{position:absolute;top:16px;left:16px;background:rgba(37,99,235,.9);padding:6px 12px;border-radius:8px;font-weight:700;color:white;font-size:18px}
    .status{padding:10px;text-align:center;font-size:13px;color:#374151}
  </style>
</head>
<body>
<header><h1>üíä PillCounter ‚Äì Web Prototype v3.4</h1></header>

<main>
  <div class="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div id="totalBadge" class="badge">Ï¥ù 0Í∞ú</div>
  </div>
  <div class="controls">
    <input id="patient" type="text" placeholder="ÌôòÏûê Ïù¥Î¶Ñ ÏûÖÎ†•" onfocus="this.placeholder=''" onblur="this.placeholder='ÌôòÏûê Ïù¥Î¶Ñ ÏûÖÎ†•'" />
    <button id="btnStart">Ïπ¥Î©îÎùº ÏãúÏûë</button>
    <button id="btnShot">Ïä§ÎßàÌä∏ Ïπ¥Ïö¥Ìä∏</button>
    <button id="btnSave" class="secondary">Ï†ÄÏû•</button>
  </div>
  <div class="status" id="status"></div>
</main>

<script>
const els = {
  video: document.getElementById('video'),
  overlay: document.getElementById('overlay'),
  btnStart: document.getElementById('btnStart'),
  btnShot: document.getElementById('btnShot'),
  btnSave: document.getElementById('btnSave'),
  totalBadge: document.getElementById('totalBadge'),
  status: document.getElementById('status'),
  patient: document.getElementById('patient')
};

let stream=null, capturedImage=null, detections=[];
const W=720,H=960; const ctx=els.overlay.getContext('2d');
els.overlay.width=W; els.overlay.height=H;

els.btnStart.onclick=async()=>{
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});
    els.video.srcObject=stream;
    els.status.textContent='Ïπ¥Î©îÎùº ÏãúÏûëÎê®';
  }catch(e){els.status.textContent='Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®';}
};

function grabFrame(){
  const tmp=document.createElement('canvas'); tmp.width=W; tmp.height=H;
  const tctx=tmp.getContext('2d');
  const vw=els.video.videoWidth,vh=els.video.videoHeight;
  if(!vw||!vh) return null;
  const targetAR=W/H, videoAR=vw/vh; let dw,dh,dx,dy;
  if(videoAR>targetAR){ dh=H; dw=H*videoAR; dx=(W-dw)/2; dy=0; }
  else { dw=W; dh=W/videoAR; dx=0; dy=(H-dh)/2; }
  tctx.drawImage(els.video,dx,dy,dw,dh);
  return tctx.getImageData(0,0,W,H);
}

function rgb2hsv(r,g,b){
  r/=255; g/=255; b/=255;
  const mx=Math.max(r,g,b), mn=Math.min(r,g,b), d=mx-mn; let h=0;
  if(d!==0){ if(mx===r) h=((g-b)/d)%6; else if(mx===g) h=((b-r)/d)+2; else h=((r-g)/d)+4; h*=60; if(h<0) h+=360; }
  const s=mx===0?0:d/mx; const v=mx; return [h,s,v];
}
function percentile(arr, p){ if(arr.length===0) return 0; const copy=Array.from(arr).sort((a,b)=>a-b); const k=Math.min(copy.length-1, Math.max(0, Math.floor((p/100)*copy.length))); return copy[k]; }
function closeMask(mask,w,h){ const tmp=new Uint8Array(mask.length); for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ let on=0; for(let dy=-1;dy<=1;dy++){ for(let dx=-1;dx<=1;dx++){ if(mask[(y+dy)*w+(x+dx)]){on=1;break;} } if(on)break; } tmp[y*w+x]=on; } } const out=new Uint8Array(mask.length); for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ let all=1; for(let dy=-1;dy<=1;dy++){ for(let dx=-1;dx<=1;dx++){ if(!tmp[(y+dy)*w+(x+dx)]){all=0;break;} } if(!all)break; } out[y*w+x]=all; } } return out; }

// --- K-means(2) on HSV to separate tray vs pills (downsampled for speed) ---
function kmeans2_HSV(hsvArray, maxIter=10){
  // hsvArray: Float32Array [h,s,v,h,s,v,...]
  const n = hsvArray.length/3;
  // init: low-S/V (tray) vs high-S/V (pills)
  let c0=[0,0,0], c1=[180,0.8,0.8];
  for(let it=0; it<maxIter; it++){
    let sum0=[0,0,0], sum1=[0,0,0], n0=0, n1=0;
    for(let i=0;i<n;i++){
      const h=hsvArray[i*3], s=hsvArray[i*3+1], v=hsvArray[i*3+2];
      const d0 = Math.min(Math.abs(h-c0[0]), 360-Math.abs(h-c0[0]))/180 + Math.abs(s-c0[1]) + Math.abs(v-c0[2]);
      const d1 = Math.min(Math.abs(h-c1[0]), 360-Math.abs(h-c1[0]))/180 + Math.abs(s-c1[1]) + Math.abs(v-c1[2]);
      if(d0<d1){ sum0[0]+=h; sum0[1]+=s; sum0[2]+=v; n0++; } else { sum1[0]+=h; sum1[1]+=s; sum1[2]+=v; n1++; }
    }
    if(n0>0){ c0=[sum0[0]/n0, sum0[1]/n0, sum0[2]/n0]; }
    if(n1>0){ c1=[sum1[0]/n1, sum1[1]/n1, sum1[2]/n1]; }
  }
  return {c0,c1};
}

function detectPills(img){
  const d=img.data, N=W*H;
  // --- helpers (scoped) ---
  function erodeLine(mask,w,h,len,dir){ const out=new Uint8Array(mask.length); const r=(len-1)/2|0; if(dir==='h'){ for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let ok=1; for(let dx=-r;dx<=r;dx++){ const xx=x+dx; if(xx<0||xx>=w||!mask[y*w+xx]){ok=0;break;} } out[y*w+x]=ok; } } } else { for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let ok=1; for(let dy=-r;dy<=r;dy++){ const yy=y+dy; if(yy<0||yy>=h||!mask[yy*w+x]){ok=0;break;} } out[y*w+x]=ok; } } } return out; }
  function dilateLine(mask,w,h,len,dir){ const out=new Uint8Array(mask.length); const r=(len-1)/2|0; if(dir==='h'){ for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let on=0; for(let dx=-r;dx<=r;dx++){ const xx=x+dx; if(xx>=0&&xx<w&&mask[y*w+xx]){on=1;break;} } out[y*w+x]=on; } } } else { for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let on=0; for(let dy=-r;dy<=r;dy++){ const yy=y+dy; if(yy>=0&&yy<h&&mask[yy*w+x]){on=1;break;} } out[y*w+x]=on; } } } return out; }
  function openCloseLine(mask,w,h){ const L=7; let hE=erodeLine(mask,w,h,L,'h'); let hO=dilateLine(hE,w,h,L,'h'); let vE=erodeLine(mask,w,h,L,'v'); let vO=dilateLine(vE,w,h,L,'v'); const merged=new Uint8Array(mask.length); for(let i=0;i<mask.length;i++) merged[i]=(hO[i]||vO[i])?1:0; // light close
    return (function(){ const tmp=new Uint8Array(merged.length); for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ let on=0; for(let dy=-1;dy<=1;dy++){ for(let dx=-1;dx<=1;dx++){ if(merged[(y+dy)*w+(x+dx)]){on=1;break;} } if(on)break; } tmp[y*w+x]=on; } } const out=new Uint8Array(merged.length); for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ let all=1; for(let dy=-1;dy<=1;dy++){ for(let dx=-1;dx<=1;dx++){ if(!tmp[(y+dy)*w+(x+dx)]){all=0;break;} } if(!all)break; } out[y*w+x]=all; } } return out; })(); }

  // Downsample HSV for k-means
  const step=4, smallW=Math.floor(W/step), smallH=Math.floor(H/step);
  const hsvSmall=new Float32Array(smallW*smallH*3); const vSmall=new Float32Array(smallW*smallH);
  for(let y=0;y<smallH;y++){
    for(let x=0;x<smallW;x++){
      const sx=x*step, sy=y*step; const idx=(sy*W+sx)*4; const [h,s,v]=rgb2hsv(d[idx],d[idx+1],d[idx+2]);
      const p=(y*smallW+x)*3; hsvSmall[p]=h; hsvSmall[p+1]=s; hsvSmall[p+2]=v; vSmall[y*smallW+x]=v;
    }
  }
  const {c0,c1}=kmeans2_HSV(hsvSmall,8);
  const pillC=(c1[1]>=c0[1])?c1:c0; // higher saturation ‚Üí pills
  const vClip=Math.min(1.0, (function(arr){ const a=Array.from(arr).sort((x,y)=>x-y); const k=Math.min(a.length-1, Math.floor(a.length*0.98)); return a[k]; })(vSmall)*0.9);

  const rawMask=new Uint8Array(N);
  for(let p=0,i=0;p<N;p++,i+=4){
    let [h,s,v]=rgb2hsv(d[i],d[i+1],d[i+2]);
    v=Math.min(v,vClip); // glare suppression
    const dh=Math.min(Math.abs(h-pillC[0]),360-Math.abs(h-pillC[0]))/180;
    const ds=Math.abs(s-pillC[1]);
    const dv=Math.abs(v-pillC[2]);
    const score=dh*0.5 + ds*1.5 + dv*0.7; // emphasize saturation
    rawMask[p]=(score<0.55 && s>0.12 && v>0.18)?1:0;
  }

  const refined=openCloseLine(rawMask,W,H);

  // Connected components
  const labels=new Int32Array(W*H); let current=1; const uf=[]; function find(x){ while(uf[x]>0) x=uf[x]; return x; } function union(a,b){ a=find(a); b=find(b); if(a!==b) uf[b]=a; }
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const idx=y*W+x; if(!refined[idx]) continue; const nb=[]; if(x>0&&refined[idx-1]) nb.push(labels[idx-1]); if(y>0){ if(refined[idx-W]) nb.push(labels[idx-W]); if(x>0&&refined[idx-W-1]) nb.push(labels[idx-W-1]); if(x<W-1&&refined[idx-W+1]) nb.push(labels[idx-W+1]); }
      if(nb.length===0){ labels[idx]=current; uf[current]=0; current++; } else { const m=Math.min(...nb.filter(v=>v>0)); labels[idx]=m; for(const n of nb){ if(n>0&&n!==m) union(m,n); } }
    }
  }
  const stats=new Map(); for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const idx=y*W+x; const l=find(labels[idx]); if(!l) continue; labels[idx]=l; let st=stats.get(l); if(!st){ st={area:0,minx:x,miny:y,maxx:x,maxy:y}; stats.set(l,st);} st.area++; if(x<st.minx) st.minx=x; if(y<st.miny) st.miny=y; if(x>st.maxx) st.maxx=x; if(y>st.maxy) st.maxy=y; } }

  const minArea=Math.max(220, Math.floor((W*H)*0.00009)); const maxArea=Math.floor((W*H)*0.02);
  const results=[]; stats.forEach(st=>{ const area=st.area; if(area<minArea||area>maxArea) return; if(st.minx<=2||st.miny<=2||st.maxx>=W-3||st.maxy>=H-3) return; const w=st.maxx-st.minx+1,h=st.maxy-st.miny+1; const ar=w/Math.max(1,h); if(ar<0.55||ar>5.0) return; const bboxArea=w*h; if(area/bboxArea<0.5) return; results.push({bbox:[st.minx,st.miny,w,h],include:true}); });
  results.sort((a,b)=> (a.bbox[1]-b.bbox[1]) || (a.bbox[0]-b.bbox[0])); return results;
}

function drawOverlay(img,dets){
  ctx.clearRect(0,0,W,H);
  if(img){ const tmp=document.createElement('canvas'); tmp.width=W; tmp.height=H; tmp.getContext('2d').putImageData(img,0,0); ctx.drawImage(tmp,0,0); }
  ctx.lineWidth=3; ctx.font='bold 20px system-ui';
  dets.forEach((d,i)=>{
    const [x,y,w,h]=d.bbox;
    ctx.strokeStyle=d.include?'#2563eb':'#ef4444';
    ctx.globalAlpha=d.include?1.0:0.4;
    ctx.strokeRect(x,y,w,h);
    ctx.globalAlpha=1.0;
    ctx.fillStyle='#111827'; ctx.fillText(i+1,x,y-6);
    if(((i+1)%5)===0 && d.include){ ctx.fillStyle='#2563eb'; ctx.fillText('‚úì',x+w-16,y-6); }
  });
  const total=dets.filter(d=>d.include).length;
  els.totalBadge.textContent=`Ï¥ù ${total}Í∞ú`;
}

els.overlay.addEventListener('click',(e)=>{
  if(!capturedImage||detections.length===0) return;
  const r=els.overlay.getBoundingClientRect();
  const x=(e.clientX-r.left)*(W/r.width), y=(e.clientY-r.top)*(H/r.height);
  for(let i=detections.length-1;i>=0;i--){ const [bx,by,bw,bh]=detections[i].bbox; if(x>=bx&&x<=bx+bw&&y>=by&&y<=by+bh){ detections[i].include=!detections[i].include; drawOverlay(capturedImage,detections); break; } }
});

els.btnShot.onclick=()=>{
  const frame=grabFrame(); if(!frame){els.status.textContent='ÏòÅÏÉÅ ÏóÜÏùå (Ïπ¥Î©îÎùº ÏãúÏûëÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî)'; return;}
  capturedImage=frame; detections=detectPills(frame);
  drawOverlay(frame,detections);
  const n = detections.filter(d=>d.include).length;
  els.status.textContent=`ÏûêÎèôÍ≤ÄÏ∂ú ÏôÑÎ£å ¬∑ ÌòÑÏû¨ ${n}Í∞ú`;
};

els.btnSave.onclick=()=>{
  if(!capturedImage){els.status.textContent='Î®ºÏ†Ä Ïä§ÎßàÌä∏ Ïπ¥Ïö¥Ìä∏Î•º Ïã§ÌñâÌïòÏÑ∏Ïöî';return;}
  const included=detections.filter(d=>d.include);
  const out=document.createElement('canvas'); out.width=W; out.height=H; const octx=out.getContext('2d');
  const tmp=document.createElement('canvas'); tmp.width=W; tmp.height=H; tmp.getContext('2d').putImageData(capturedImage,0,0); octx.drawImage(tmp,0,0);
  drawOverlay(null,included); octx.drawImage(els.overlay,0,0);
  const name=els.patient.value.trim()||'Ïù¥Î¶ÑÏóÜÏùå'; const now=new Date(); const stamp=now.toLocaleString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  octx.fillStyle='rgba(0,0,0,.6)'; octx.fillRect(16,H-40,W-32,30);
  octx.fillStyle='#fff'; octx.font='16px bold system-ui'; octx.fillText(`${stamp} | ${name}`,24,H-20);
  out.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);const y=now.getFullYear();const m=String(now.getMonth()+1).padStart(2,'0');const d=String(now.getDate()).padStart(2,'0');const hh=String(now.getHours()).padStart(2,'0');const mm=String(now.getMinutes()).padStart(2,'0');a.download=`${y}-${m}-${d}_${hh}-${mm}_${name}_Ï∫°Ïäê-${included.length}.png`;a.click();},'image/png');
};
</script>
</body>
</html>
