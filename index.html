<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>TXT 런처</title>
  <meta name="theme-color" content="#69b10d">
  <style>
    :root { --accent:#69b10d; --card:#fff; --bg:#f7fafc; --border:#e5e7eb; --text:#0f172a; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}

    /* Header */
    header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 14px; z-index:20; }
    .bar{ max-width:980px; margin:0 auto; display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; }
    h1{ margin:0; font-size:18px; font-weight:900; letter-spacing:.2px; }
    .repo{ font-size:12px; color:#475569 }
    .tools{ display:flex; gap:8px; align-items:center; justify-self:end; }

    /* Controls */
    .input{ height:36px; padding:0 12px; border:1px solid var(--border); background:#fff; border-radius:10px; }
    .btn{ height:36px; padding:0 12px; border:1px solid var(--border); background:#fff; border-radius:10px; font-weight:700; font-size:13px; cursor:pointer; }
    .btn.primary{ background:var(--accent); color:#fff; border-color:transparent; }
    .btn.toggle[aria-pressed="true"]{ background:#111; color:#fff; border-color:#111; }
    .btn.ghost{ background:transparent; }

    /* Layout */
    main{ padding:14px; max-width:980px; margin:0 auto; }
    .list{ display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .name{ font-weight:900; font-size:14px; word-break:break-all; display:flex; align-items:center; gap:8px; }
    .name .chev{ font-size:16px; opacity:.7; transition: transform .18s ease; }
    .meta{ font-size:12px; color:#64748b; display:flex; gap:8px; flex-wrap:wrap; }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    .preview{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; line-height:1.5; color:#111827; background:#f1f5f9; border:1px dashed #cbd5e1; border-radius:10px; padding:10px; max-height:180px; overflow:auto; white-space:pre-wrap; }
    .empty, .error{ text-align:center; color:#475569; margin-top:32px; }
    footer{ padding:18px; text-align:center; color:#94a3b8; font-size:12px; }

    /* —— 제목만 보기 모드 —— */
    body.titles-only .card .meta,
    body.titles-only .card .btns,
    body.titles-only .card .preview { display:none; }
    body.titles-only .card .name { cursor:pointer; }
    body.titles-only .card.expanded .meta,
    body.titles-only .card.expanded .btns,
    body.titles-only .card.expanded .preview { display:block; }
    body.titles-only .card.expanded .name .chev{ transform: rotate(90deg); }

    /* compact list mode (optional future) */
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div>
        <h1> <img src="icon.png" alt="icon" style="height:5em; vertical-align:middle;border-radius:12px;"> </h1>
        <div class="repo" id="repoLabel"></div>
      </div>
      <div></div>
      <div class="tools">
        <input id="q" class="input" type="search" placeholder="파일 검색…" />
        <button class="btn" id="refreshBtn" title="목록 새로고침">N</button>
        <button class="btn toggle" id="titlesOnlyBtn" aria-pressed="false" title="제목만 보기 토글">Title</button>
        <button class="btn ghost" id="expandAllBtn" style="display:none;" title="모두 펼치기/접기">모두 펼치기</button>
      </div>
    </div>
  </header>

  <main>
    <div id="list" class="list" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none;">표시할 txt 파일이 없어요.</div>
    <div id="err" class="error" style="display:none;"></div>
  </main>

  <footer>자동 목록 갱신 · GitHub Contents API 사용</footer>

<script>
/** ================= 설정 =================
 * 필요 시 아래 OWNER/REPO/BRANCH/DIR만 바꾸면 됩니다.
 */
const OWNER  = "hodewdew-creator";  // ← 변경 가능
const REPO   = "ZHYUNK";            // ← 변경 가능
const BRANCH = "main";              // ← 변경 가능
const DIR    = "";                  // 특정 폴더만 볼 땐 "notes" 등

/** =============== 내부 로직 =============== **/
const apiBase = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(DIR)}?ref=${encodeURIComponent(BRANCH)}`;
const repoLabel = document.getElementById('repoLabel');
repoLabel.textContent = `${OWNER}/${REPO}@${BRANCH}${DIR ? " / "+DIR : ""}`;

const $list = document.getElementById('list');
const $empty = document.getElementById('empty');
const $err = document.getElementById('err');
const $q = document.getElementById('q');
const $refresh = document.getElementById('refreshBtn');
const $titlesToggle = document.getElementById('titlesOnlyBtn');
const $expandAll = document.getElementById('expandAllBtn');

let allFiles = [];
let titlesOnly = false;
let expandStateAll = false; // 제목만 모드에서 전체 펼치기 상태

async function fetchTxtList(){
  $err.style.display = "none";
  $empty.style.display = "none";
  $list.innerHTML = "";
  try{
    const res = await fetch(apiBase, { headers: { "Accept": "application/vnd.github+json" }});
    if(!res.ok){
      const text = await res.text();
      throw new Error(`API ${res.status}: ${text}`);
    }
    const data = await res.json();
    const items = Array.isArray(data) ? data : [data];
    const txts = items.filter(x => x.type === "file" && x.name.toLowerCase().endsWith(".txt"));

    // 이름 오름차순
    txts.sort((a,b)=> a.name.localeCompare(b.name, 'ko'));
    allFiles = txts;
    render(txts);
  }catch(e){
    console.error(e);
    $err.textContent = "불러오기에 실패했어요. (깃허브 API 제한이거나 설정값이 잘못됨)";
    $err.style.display = "block";
  }
}

function render(files){
  $list.innerHTML = "";
  if(files.length === 0){ $empty.style.display = "block"; return; }

  files.forEach(f => {
    const card = document.createElement('div');
    card.className = "card";

    const name = document.createElement('div');
    name.className = "name";
    name.innerHTML = `<span class="chev">▸</span><span class="t">${escapeHtml(f.name)}</span>`;

    const meta = document.createElement('div');
    meta.className = "meta";
    meta.innerHTML = `
      <span>size: ${formatSize(f.size)}</span>
      <span>path: ${escapeHtml(f.path)}</span>
    `;

    const btns = document.createElement('div');
    btns.className = "btns";
    const rawUrl = f.download_url || rawUrlFromPath(f.path);
    const viewBtn = button("보기", "primary", async () => {
      const text = await fetchText(rawUrl);
      pre.textContent = firstLines(text, 2000);
    });
    const rawBtn = linkBtn("원본 열기", rawUrl);
    const ghBtn  = linkBtn("GitHub 보기", f.html_url);
    btns.append(viewBtn, rawBtn, ghBtn);

    const pre = document.createElement('pre');
    pre.className = "preview";
    pre.textContent = "미리보기를 누르면 내용이 보여요.";

    // 제목만 모드에서 개별 펼치기
    name.addEventListener('click', ()=>{
      if(!titlesOnly) return;
      card.classList.toggle('expanded');
    });

    card.append(name, meta, btns, pre);
    $list.appendChild(card);
  });

  updateChevrons();
}

function button(label, cls, onClick){
  const b = document.createElement('button');
  b.className = `btn ${cls||""}`;
  b.type = 'button';
  b.textContent = label;
  b.onclick = onClick;
  return b;
}
function linkBtn(label, href){
  const a = document.createElement('a');
  a.className = "btn";
  a.textContent = label;
  a.href = href;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  return a;
}
async function fetchText(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error("raw fetch error");
  return await res.text();
}
function firstLines(str, maxChars){
  return (str.length > maxChars) ? str.slice(0,maxChars) + "\n…(이하 생략)" : str;
}
function formatSize(n){
  if(n < 1024) return n + " B";
  if(n < 1024*1024) return (n/1024).toFixed(1) + " KB";
  return (n/1024/1024).toFixed(1) + " MB";
}
function rawUrlFromPath(path){
  return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${encodeURIComponent(path).replace(/%2F/g,'/')}`;
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

// 검색
$q.addEventListener('input', ()=>{
  const q = $q.value.trim().toLowerCase();
  if(!q){ render(allFiles); return; }
  render(allFiles.filter(f => f.name.toLowerCase().includes(q) || f.path.toLowerCase().includes(q)));
});

// 새로고침
$refresh.addEventListener('click', fetchTxtList);

// 제목만 보기 토글
$titlesToggle.addEventListener('click', ()=>{
  titlesOnly = !titlesOnly;
  document.body.classList.toggle('titles-only', titlesOnly);
  $titlesToggle.setAttribute('aria-pressed', String(titlesOnly));
  $expandAll.style.display = titlesOnly ? 'inline-block' : 'none';
  expandStateAll = false;
  $expandAll.textContent = '모두 펼치기';
  updateChevrons();
});

// 모두 펼치기/접기 (제목만 모드에서만 노출)
$expandAll.addEventListener('click', ()=>{
  if(!titlesOnly) return;
  expandStateAll = !expandStateAll;
  document.querySelectorAll('.card').forEach(c => {
    c.classList.toggle('expanded', expandStateAll);
  });
  $expandAll.textContent = expandStateAll ? '모두 접기' : '모두 펼치기';
  updateChevrons();
});

function updateChevrons(){
  // 제목만 모드일 때만 화살표 표시, 아니면 숨김
  document.querySelectorAll('.card .chev').forEach((el)=>{
    el.style.visibility = titlesOnly ? 'visible' : 'hidden';
    const expanded = el.closest('.card')?.classList.contains('expanded');
    el.style.transform = expanded ? 'rotate(90deg)' : 'rotate(0deg)';
  });
}

// 초기 로드
fetchTxtList();
</script>
</body>
</html>
